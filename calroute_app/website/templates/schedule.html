<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Schedule</title>
    <link rel="stylesheet" href="/static/css/schedule.css">
    <style>
        /* Basic styles in case schedule.css is not loaded */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
        }
        .carousel-container {
            width: 40%;
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        h1 {
            margin-top: 0;
            color: #333;
        }
        .task-carousel-vertical {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .task-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .task-card.done {
            background-color: #e8f5e9;
        }
        .edit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        #map {
            height: 100vh;
            width: 60%;
        }
    </style>
</head>
<body>
    <div class="carousel-container">
        <h1>Welcome, {{ user.name }}!</h1>
        <div class="task-carousel-vertical">
            {% for task in user.raw_tasks %}
                <div class="task-card {% if task.completed %}done{% endif %}">
                    <button class="edit-btn" onclick="editTask('{{ task.raw_task_id }}')">✏️</button>
                    <h3>{{ task.title }}</h3>
                    {% if task.description %}
                        <p>{{ task.description }}</p>
                    {% endif %}
                    {% if task.start_time %}
                        <p><strong>Start:</strong> {{ task.start_time.astimezone(task.start_time.tzinfo).strftime('%I:%M %p') }}</p>
                    {% endif %}
                    {% if task.end_time %}
                        <p><strong>End:</strong> {{ task.end_time.astimezone(task.end_time.tzinfo).strftime('%I:%M %p') }}</p>
                    {% endif %}
                    {% if task.location_id %}
                        <p><strong>Location:</strong>
                        {% if task.location %}
                            {{ task.location.name }}
                        {% endif %}
                        </p>
                    {% endif %}
                    <p><strong>Source:</strong> {{ task.source }}</p>
                </div>
            {% else %}
                <div class="task-card">
                    <h3>No tasks scheduled for today</h3>
                </div>
            {% endfor %}
        </div>
    </div>

    <div id="map" style="height: 500px; width: 100%;"></div>
    <script>
        // gets JSON-encoded list of {lat,lng,title}
        const orderedLocations = {{ task_locations|tojson }};
        console.log("Map init called", orderedLocations);

        function initMap() {
          if (!orderedLocations.length) return;
          const map = new google.maps.Map(
            document.getElementById("map"),
            { zoom: 12, center: orderedLocations[0] }
          );

          const directionsService  = new google.maps.DirectionsService();
          const directionsRenderer = new google.maps.DirectionsRenderer({ map });

          const origin      = orderedLocations[0];
          const destination = orderedLocations[orderedLocations.length - 1];
          const waypoints   = orderedLocations
            .slice(1, -1)
            .map(loc => ({ location: loc, stopover: true }));

          directionsService.route(
            { origin, destination, waypoints,
              optimizeWaypoints: false,
              travelMode: google.maps.TravelMode.DRIVING },
            (resp, status) => {
              if (status === "OK") {
                directionsRenderer.setDirections(resp);
              } else {
                console.error("Directions failed:", status);
              }
            }
          );
        }

        window.initMap = initMap;
      </script>

  <!-- Call initMap after loading -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC_Dz0XtugoW2odkRb-QGaMT96bA0y9YJs&callback=initMap">
  </script>
    <script>
        function editTask(taskId) {
            alert('Edit task ' + taskId);
            // Redirect or open a modal as needed:
            // window.location.href = ⁠ /edit-task/${taskId} ⁠;
        }
    </script>
</body>
</html>